<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Form</title>
</head>
<body>
    <h1>Upload Form</h1>
    <input type="file" id="fileInput" name="file" accept=".*" onchange="handleFileSelect(event)">
    <button type="button" id="uploadButton" onclick="uploadChunks()">Upload</button>

    <script>
        let fileChunks = [];
        let fileName = ''; // Variable to store the name of the original file
        const totalChunks = 5; // Variable to store the number of chunks

        function handleFileSelect(event) {
            const file = event.target.files[0];
            const fileSize = file.size;

            fileChunks = [];
            fileName = file.name; // Store the name of the original file

            console.log(`File selected: ${fileName}`);
            console.log(`Total file size: ${fileSize} bytes`);
            console.log(`Number of chunks: ${totalChunks}`);

            const chunkSize = Math.ceil(fileSize / totalChunks);

            let start = 0;

            for (let i = 0; i < totalChunks; i++) {
                const chunk = file.slice(start, start + chunkSize);
                fileChunks.push(chunk);
                start += chunkSize;
            }
        }

        async function uploadChunks() {
            console.log('Uploading chunks...');

            // Create an array to hold all the upload promises
            const uploadPromises = [];

            for (let i = 0; i < totalChunks; i++) {
                const formData = new FormData();
                formData.append('file', fileChunks[i], `${i+1}-`+fileName);
                formData.append('filename',fileName);
                formData.append('totalChunks', totalChunks);
                formData.append('chunkNumber', i + 1);

                // Send the chunk upload request asynchronously and store the promise
                const uploadPromise = uploadChunk(formData,i+1);
                uploadPromises.push(uploadPromise);
            }

            // Wait for all upload promises to resolve
            await Promise.all(uploadPromises);
            console.log('All chunks uploaded successfully.');
            const filename = fileName; 

            fetch(`/combine?filename=${encodeURIComponent(filename)}`)
                .then(response => {
                    if (!response.ok) {
                    throw new Error('Network response was not ok');
                    }
                    return response.text(); // Fetch response as text
                })
                .then(data => {
                    // Handle the text data returned from the server
                    console.log(`The final response from server: ${data}`);
                })
                .catch(error => {
                    // Handle any errors that occurred during the fetch
                    console.error('Fetch error:', error);
                });

            
        }

        async function uploadChunk(formData,progress) {
            try {
                const response = await fetch('/documents', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.text();
                console.log(`Client Response: The file ${progress} sent to server!`);
                console.log('Server response:', result); // Log the response from the server
            } catch (error) {
                console.error('Error uploading chunk:', error);
            }
        }
    </script>
</body>
</html>
